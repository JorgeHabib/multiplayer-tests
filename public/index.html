<!DOCTYPE html>
<html lang="en">
    
<head>
    <meta charset="UTF-8">
    <title>MyMoba</title>
    <link rel="stylesheet" href="./styles/statusBarStyles.css" type='text/css'>
    <link rel="stylesheet" href="./styles/generalStyles.css" type='text/css'>
    <link rel="stylesheet" href="./styles/classStyles.css" type='text/css'>
    <link rel="stylesheet" href="./styles/skillsStyles.css" type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Orbitron' rel='stylesheet' type='text/css'>
    <script src="/socket.io/socket.io.js"></script>
</head>

<body>
    <div id="myInfos"></div>
    <canvas id="screen" width=1680 height=1680></canvas>
    <div id="enemyInfos"></div>

    <script type="module">
        import * as utils from './utils.js';
        import renderScreen from './screen/render.js';
        import renderMenuArea from './screen/menu.js';
        import { updateStats, updateCooldowns } from './screen/update.js'
        import createGame from './game/createGame.js';
        import createKeyboardListener from './keyboard.js';
        import handleReady from './screen/ready.js';
        import handlePreparingMode from './screen/preparation.js';
        import fitClasses from './classes.js';
        import createSkillshot from './skills/skillshot.js'

        const socket = io();

        const game = createGame();
        const keyboardListener = createKeyboardListener(game, document, socket);

        socket.on('connect', () => {
            const playerID = socket.id;
            console.log(`Player connected: ${playerID}`);

            const flexibleHeight = window.innerHeight - 30;

            const screen = document.getElementById('screen');
            screen.style.height = `${flexibleHeight}px`;
            renderScreen(screen, game, requestAnimationFrame, playerID);
        });

        socket.on('setup', (state) => {
            const playerID = socket.id;
            game.setState(state);
            const screen = document.getElementById('screen');

            if (game.state.players[playerID].spect === false) {
                keyboardListener.registerPlayerID(playerID);
                keyboardListener.subscribeObserver((command) => {
                    socket.emit(command.type, command);
                });

                addEventListener('mousemove', (e) => {
                    const rect = screen.getBoundingClientRect();
                    const scaleX = screen.width / rect.width;
                    const scaleY = screen.height / rect.height;

                    game.state.players[playerID].mouse = {
                        mouseX: (e.clientX - rect.left) * scaleX,
                        mouseY: (e.clientY - rect.top) * scaleY
                    }
                })

                const button = document.createElement('button');
                button.innerHTML = 'READY!';
                button.id = 'ready';
                button.className = 'notReady'
                button.addEventListener('click', () => handleReady(button, socket, game, playerID));

                const divClasses = document.createElement('div');
                divClasses.id = 'classDesc';
                divClasses.className = 'classDesc';
                fitClasses(divClasses, game, playerID);

                const infos = document.getElementById('myInfos');
                infos.appendChild(divClasses);
                infos.appendChild(button);
            }
        });

        socket.on('controll-player', (command) => {
            console.log(`Receiving ${command.type} -> ${command.playerID}`);

            const playerID = socket.id;

            game.movePlayer(command);
        });

        socket.on('abitily-used', (command) => {
            console.log(`Receiving ${command.type} -> ${command.playerID}`);

            const playerID = socket.id;

            let enemyID;
            
            if (game.state.blueID === playerID) {
                enemyID = game.state.redID;
            } else {
                enemyID = game.state.blueID;
            }

            game.playerSkill(command);
            updateStats(game, document, playerID, enemyID);
        })

        socket.on('add-player', (command) => {
            console.log(`Receiving ${command.type} -> ${command.playerID}`);
            game.addPlayer(command);
        });

        socket.on('remove-player', (command) => {
            console.log(`Receiving ${command.type} -> ${command.playerID}`);
            game.removePlayer(command);
        });

        socket.on('blue-side-ready', (command) => {
            const playerID = socket.id;

            console.log(`Receiving ${command.type} -> ${command.playerID}`);
            game.setReady(command);

            if (game.state.gameStarted) {
                const blueSideChar = `${game.state.players[game.state.blueId].class.className}Skills`;
                const redSideChar = `${game.state.players[game.state.redId].class.className}Skills`;
                const skills = getSkillObject(game, blueSideChar, redSideChar);
                game.setupSkills(skills);
                updateCooldowns(game, document, playerID);

                const button = document.getElementById('ready');
                const classInfo = document.getElementById('classDesc');

                classInfo.remove();
                button.remove();

                handlePreparingMode(document, game);
                insertMenuArea(game, playerID, document);
            }
        });

        socket.on('red-side-ready', (command) => {
            const playerID = socket.id;

            console.log(`Receiving ${command.type} -> ${command.playerID}`);
            game.setReady(command);

            if (game.state.gameStarted) {
                const blueSideChar = `${game.state.players[game.state.blueId].class.className}Skills`;
                const redSideChar = `${game.state.players[game.state.redId].class.className}Skills`;
                console.log(redSideChar);
                const skills = getSkillObject(game, blueSideChar, redSideChar);
                game.setupSkills(skills);
                updateCooldowns(game, document, playerID);

                const button = document.getElementById('ready');
                const classInfo = document.getElementById('classDesc');

                classInfo.remove();
                button.remove();

                handlePreparingMode(document, game);
                insertMenuArea(game, playerID, document);
            }
        });

        socket.on('forceDisconnect', socket.disconnect);

    </script>
</body>

</html>
